#!/bin/bash

# Reset
Color_Off='\033[0m'       # Text Reset

# Regular Colors
export Black='\033[0;30m'        # Black
export Red='\033[0;31m'          # Red
export Green='\033[0;32m'        # Green
export Yellow='\033[0;33m'       # Yellow
export Blue='\033[0;34m'         # Blue
export Purple='\033[0;35m'       # Purple
export Cyan='\033[0;36m'         # Cyan
export White='\033[0;37m'        # White

# Bold
export BBlack='\033[1;30m'       # Black
export BRed='\033[1;31m'         # Red
export BGreen='\033[1;32m'       # Green
export BYellow='\033[1;33m'      # Yellow
export BBlue='\033[1;34m'        # Blue
export BPurple='\033[1;35m'      # Purple
export BCyan='\033[1;36m'        # Cyan
export BWhite='\033[1;37m'       # White

while true
do
    clear
    echo -e "${BRed}"
    echo  "NaviSec"  | figlet
    echo -e "${Color_Off}"
    echo ""
    host="remote.navisec.xyz"
    key_filename="/etc/odyss_key"

    if [ ! -f "$key_filename" ]
    then
        echo "No key detected, generating one..."
        /usr/bin/diceware >> "$key_filename"
    fi

    key="$(cat "$key_filename")"
    echo -e "${BWhite}Your personalization key is ${BGreen}'$key'${Color_Off}"
    data=$(timeout 3 curl -s "https://$host/init/$key")
    auth=$(echo $data | jq .auth)

    if [ "$auth" == "true" ]
    then
        if [ ! -f "/etc/openvpn/openvpn.conf" ]
        then
            echo $data | jq -r .config >> /etc/openvpn/openvpn.conf
            reboot
        else
            echo -e "${BWhite}Auth Status: ${BGreen} Authenticated${Color_Off}"
        fi
    else
        echo -e "${BWhite}Auth Status: ${BRed} Not Authenticated${Color_Off}"
        killall openvpn 2>/dev/null
        if [ -f "/etc/openvpn/openvpn.conf" ]
        then
            rm /etc/openvpn/openvpn.conf
        fi
    fi
    external_ip=$(timeout 10 curl -s https://icanhazip.com)
    remote_ip=$(dig +short remote.navisec.xyz)
    echo -e "${BWhite}Public IP: ${BGreen}'$external_ip'${Color_Off}" 
    if [ "$external_ip" == "$remote_ip" ]
    then
        echo -e "${BWhite}Connection Status:${BGreen} Currently connected to the NaviSec network!${Color_Off}" 
    else
        echo -e "${BWhite}Connection Status:${BRed} Not Connected${Color_Off}" 
        rc-service openvpn restart 2>/dev/null
    fi
    echo -n -e "${Green}"
    ifconfig eth0
    ifconfig tun0
    echo -n -e "${Color_Off}"
    sleep 10
done